---
title: 'Green Space & Residential Demographic Patterns: 1990 to 2010'
author: "Francine Stephens"
date: "Last Updated: `r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: flatly
    highlight: espresso
---

```{r setup, include=F, warning=F, message=F}
knitr::opts_chunk$set(echo=T)

## LIBRARIES
packages <- c(
  "readr",
  "tidyverse",
  "sf",
  "ggplot2",
  "scales",
  "units",
  "ggcorrplot",
  "modelsummary",
  "stargazer",
  "panelr",
  "tmap",
  "tigris",
  "censusapi", 
  "tidycensus",
  "corrplot",
  "RColorBrewer",
  "hrbrthemes",
  "viridis"
)
lapply(packages, library, character.only = T)

## PATHS
setwd("~/Projects/public_space")
wd <- getwd()
green_space_path <- "/green_space/gee/"
census_data_path <- "/census"
shp_repo <- "C:/Users/Franc/Documents/Shapefile_Repository"
shp2010_path <- "/2010USA_CensusGeog_Shp"
cbsa_path <- "/tl_2010_us_cbsa10/"
metdiv_path <- "/tl_2010_us_metdiv10/"
cbg10_path <- "/us_blck_grp_2010/"
places10_path <- "/tl2010_us_place_2010/"

## APIs
census_api_key("99ccb52a629609683f17f804ca875115e3f0804c",  overwrite = T)
Sys.setenv(CENSUS_KEY="99ccb52a629609683f17f804ca875115e3f0804c")

## SHAPEFILE IMPORTS
cbg10 <- st_read(paste0(shp_repo,
                        shp2010_path,
                        cbg10_path,
                        "US_blck_grp_2010.shp"), 
                 quiet = F)

```

## Data Preparation

* EVI scores come from Landsat satellite image mosaics from 1990, 2000, and 2010. <span style="color: red;">Return and add more recent data 2020 because some of the biggest shifts within places appear to occur between 2010 and 2020</span>
* Decennial U.S. Census data for each decade. <span style="color: red;">Return and add 2019 ACS to capture more recent shifts</span>
  * Race
  * Population density
  * Housing units
  * Housing tenure - % renter-occupied housing units
  * Housing occupancy - % vacant housing units
* Other Environmental Data:
  * Precipitation - mm in previous 6 months
  * Eco-regions - 12 classes. Classes are based on the regional ecosystem - soil, landform, major vegetation types, climate.

```{r data imports, warning=F, message=F}
## DATA IMPORTS-----------------------------------------------------------------
evi_all_decades_cbg <- readRDS(paste0(wd, 
                                      green_space_path,
                                      "evi_all_years_on_2010cbg_LONG.rds"))

race_all_decades_cbg <- readRDS(paste0(wd, 
                         census_data_path, 
                         "/all_decades_race_on_cbg10_LONG.rds"))

counties <- get_decennial(geography = "county", 
                          variables = "P001001", 
                          year = 2010) 

places <- get_decennial(geography = "place", 
                        variables = "P001001", 
                        year = 2010) 

cbg_higher_geog_ids <- readRDS(paste0(shp_repo,
                                      "/cbg_full_geog_identifers.rds"))
top100_cbsa <- read_csv(paste0(shp_repo, 
                               "/top100_cbsa_2010bounds.csv"))
top100_places <- read_csv(paste0(shp_repo, 
                                 "/top100_places_2010bounds.csv"))

```


````{r data prep, message=F, warning=F}
#DATA PREPARATION---------------------------------------------------------------
## MERGE ALL GEOIDs
top100_cbsa <- top100_cbsa %>%
  mutate(CBSAFP = as.character(CBSAFP)) %>%
  select(-CBSA_NM) %>%
  rename(top100_cbsa="top_100", cbsa_rank_pop_size="rank_pop_size")

top100_places <- top100_places %>%
  select(-PLACE_NM) %>%
  rename(top100_place="top_100", place_rank_pop_size="rank_pop_size")

counties <- counties %>%
  select(PLACEFP_DERIVED="GEOID", PLACE_DERIVED_NM="NAME")

cbg_all_geoids <- cbg10 %>%
  st_set_geometry(NULL) %>%
  select(GEOID10, GISJOIN) %>%
  left_join(., cbg_higher_geog_ids, by=c("GEOID10", "GISJOIN")) %>%
  mutate(PLACEFP_DERIVED = if_else(is.na(PLACEID),
                                   str_sub(GEOID10, end=5),
                                   PLACEID)) %>% 
  left_join(., counties, by = "PLACEFP_DERIVED") %>%
  mutate(PLACE_DERIVED_NM=coalesce(PLACE_DERIVED_NM, PLACE_NM)) %>%
  relocate(PLACEFP_DERIVED, .after=PLACEID) %>%
  relocate(PLACE_DERIVED_NM, .after=PLACE_NM) %>%
  left_join(., top100_places, by=c("PLACEID"="PLACEFP")) %>%
  left_join(., top100_cbsa, by=c("CBSAFP10"="CBSAFP")) %>%
  mutate(in_metro = if_else(str_detect(CBSA_NM, "Metro"),
                            "Metropolitan Area",
                            "Micropolitan Area")
         )

## AREAL CALCULATIONS
cbg_area <- cbg10 %>%
  select(GEOID10) %>%
  mutate(area = st_area(.),
         area = as.numeric(set_units(area, mi^2))
         ) %>%
  st_set_geometry(NULL)


## MERGE ALL DEMOGRAPHIC & GREEN SPACE DATA
race_pct_all_decades_cbg <- race_all_decades_cbg %>% 
  mutate_at(vars(WHITE_NH:HISPANIC), funs("PCT" = (./TOT_POP) * 100)) %>%
  select(GEOID, wave, TOT_POP, WHITE_NH_PCT:HISPANIC_PCT)

full_cbg_data <- evi_all_decades_cbg %>% 
  left_join(., cbg_all_geoids, by = "GISJOIN") %>%
  left_join(., race_pct_all_decades_cbg, by = c("GEOID10" = "GEOID",
                                                "wave" = "wave")) %>% 
  relocate(evi, .before = TOT_POP) %>%
  left_join(., cbg_area, by = "GEOID10") %>%
  mutate(POP_DENS = TOT_POP/area)

```

## Metro-Micro Area Comparison

Greenness (EVI/NDVI) may take on different meanings/levels in metropolitan and micropolitan areas. Previous work has suggested that they shouldn't be studied together. If we look at the distributions of EVI at the place level across metro and micropolitan areas, there do not appear to be striking differences. 

* The middle of the distribution tends to hover around 0.45 and increases over time. 
* Noticeably, the distribution for metro areas tends to spread more over time, especially as of 2020. Although the variation in greenness in micropolitan areas is appreciable in 2020 compared to previous decades, there is more clumping of values across the distribution in micropolitan areas, whereas the the tails of the metro area distribution are not as dense.

```{r violin evi metro and micro, message=F, warning=F}
place_evi_by_year <- full_cbg_data %>%
  ungroup() %>%
  group_by(PLACEFP_DERIVED, PLACE_DERIVED_NM, wave, in_metro) %>% 
  filter(!is.na(in_metro)) %>%
  summarize(evi_mean = mean(evi, na.rm=T),
            n = n())

metro_micro_place_evi_comparison <- place_evi_by_year %>%
  ungroup() %>%
  filter(!is.na(evi_mean)) %>%
  group_by(in_metro, wave) %>%
  summarize_at(vars(evi_mean), list(mean = mean, sd = sd, median = median, min = min, max = max))

violin_evi_by_metro_status <- place_evi_by_year %>%
  ggplot(aes(fill = as.factor(wave), y = evi_mean, x = in_metro)) + 
    geom_violin(position = "dodge", alpha=0.5, outlier.colour="transparent") +
    scale_fill_viridis(discrete  =T, name = "") +
    theme_ipsum()  +
    xlab("Metropolitan-Micropolitan Status") +
    theme(legend.position="right") +
    ylab("Average EVI") +
    ggtitle("Place-level EVI by Metro & Micro Area")
 
violin_evi_by_metro_status
  
```

The summary statistics indicate noticeable increases from 2010 to 2020 for metro and micro areas at both the center and tails of the distributions. 

```{r evi metro and micro sum stats, message=F, warning=F}
metro_micro_place_evi_comparison <- place_evi_by_year %>%
  ungroup() %>%
  filter(!is.na(evi_mean)) %>%
  group_by(in_metro, wave) %>%
  summarize_at(vars(evi_mean), list(mean = mean, sd = sd, median = median, min = min, max = max))

knitr::kable(metro_micro_place_evi_comparison,
             digits = 3,
             caption = "Summary of Place-Level EVI by Metro-Micro Area",
             col.names = c("Region Type", "Year", "Mean", "SD", "Median", "Min", "Max")
             )
```


## Neighborhood Racial Composition & Greenness

The figure below illustrates the relationship between the average neighborhood racial composition and the EVI level for each decade. NOTE: 2020 is blank because 2019 ACS data have not been incorporated yet.  

The average neighborhood with an EVI of 0.5 was 83% white in 1990, 74% white in 2000, and 65% in 2010. The average share of Hispanics in a neighborhood of that same greenness level was 3% in 1990 and then 12% in 2010.  

If we look at a neighborhood with a low average EVI such as 0.1, the average share of whites in 1990 was 48% and then fell to 38% in 2010. 

Lastly, at the high end of the greenness scale around 0.8, the average share of whites in a neighborhood was 96% in 1990 and 93% in 2010. The average percent of Hispanics in a highly green neighborhood was less than 1% in 1990 and 3% in 2010, while the share of Black residents hovered around 2% across this time period. 

Overall, as the EVI increases, the average percent of whites also increased. However, as of 2010, minorities - particularly, Hispanics and Blacks, make up larger average shares of greener neighborhoods. This pattern appears across each focal year.

NOTE: The racial breakdown for high EVI values in 1990 is a little strange. Need to investigate what is driving the steep drop in % white/increase in % Black.

```{r evi and racial comp at cbg level, message=F, warning=F}
## CBG EVI
average_cbg_composition_by_evi <- full_cbg_data %>% 
  ungroup() %>%
  filter(evi >= 0 & evi <= 1,
         !is.na(evi),
         in_metro == "Metropolitan Area") %>%
  mutate(wave = as.character(wave),
         evi = round(evi, 2)) %>%
  group_by(wave) %>%
  select(wave, evi, WHITE_NH_PCT:HISPANIC_PCT) %>%
  group_by(wave, evi) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE))) %>%
  pivot_longer(
   cols = ends_with("_PCT"),
   names_to = "race",
   values_to = "percent",
 ) %>%
  mutate(race = str_remove(race, "_PCT"))


ggplot(average_cbg_composition_by_evi, aes(x=evi, y=percent, fill=race)) + 
   geom_area(alpha=0.6 , size=.5, colour="white") +
    facet_wrap(~ wave, nrow = 4) +
    scale_fill_brewer(palette = "Set2") +
    theme_minimal() + 
    labs(title = "Average Neighborhood Composition by Level of Greenness",
         y = "Average Neighborhood Composition (%)",
         x = "EVI",
         fill = "Race")


```

## Multivariate Analysis

* The goal is to get at changes in evi and race composition within neighborhoods and places, so run time fixed effects models.
  * Non-spatial model and spatial error model. The spatial error model would account for residual spatial autocorrelation.
* Focal predictor is % race group.
* Adjust for environmental variables and demographic confounders listed above. 
